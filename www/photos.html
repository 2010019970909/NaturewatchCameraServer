<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Photos</title>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-12"><h1>Photos</h1></div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <h2>How to save a photo:</h2>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <p>
                If you're on a phone, tap and hold the photo to save it.
            </p>
            <p>
                On a computer, you can download individual photos by right clicking on them and clicking save, or by
                clicking on the "Download visible photos" button. To download all photos, select the "all" page size
                first.
            </p>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <button id="download-zip" class="btn btn-primary">Download visible photos</button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <button class="btn btn-danger" data-dest="delete">Delete all photos</button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="btn-group" id="delete-confirm">
                <button class="btn btn-default">Are you sure?</button>
                <button class="btn btn-danger" data-dest="delete-yes">Yes</button>
                <button class="btn btn-info" data-dest="delete-no">No</button>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="btn-group" id="delete-confirm2">
                <button class="btn btn-default">Really sure?</button>
                <button class="btn btn-danger" data-dest="delete-final">Yes</button>
                <button class="btn btn-info" data-dest="delete-no">No</button>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-9">
            <nav id="page-nav" aria-label="Photo page selector">
                <ul class="pagination pagination-sm">
                    <li class="page-item move-backwards disabled" data-amount="all">
                        <a class="page-link" href="javascript:void(0);" data-toggle="tooltip" data-placement="top"
                           title="Back to start">|&lt;</a>
                    </li>
                    <li class="page-item move-backwards disabled" data-amount="10">
                        <a class="page-link" href="javascript:void(0);" data-toggle="tooltip" data-placement="top"
                           title="Back 10 pages">&lt;&lt;</a>
                    </li>
                    <li class="page-item move-backwards disabled" data-amount="1">
                        <a class="page-link" href="javascript:void(0);" data-toggle="tooltip" data-placement="top"
                           title="Back 1 page">&lt</a>
                    </li>
                    <li class="page-item page-number disabled">
                        <a class="page-link" href="javascript:void(0);">1</a>
                    </li>
                    <li class="page-item move-forwards disabled" id="next" data-amount="1">
                        <a class="page-link" href="javascript:void(0);" data-toggle="tooltip" data-placement="top"
                           title="Forward 1 page">&gt;</a>
                    </li>
                    <li class="page-item move-forwards disabled" data-amount="10">
                        <a class="page-link" href="javascript:void(0);" data-toggle="tooltip" data-placement="top"
                           title="Forward 10 pages">&gt;&gt;</a>
                    </li>
                    <li class="page-item move-forwards disabled" data-amount="all">
                        <a class="page-link" href="javascript:void(0);" data-toggle="tooltip" data-placement="top"
                           title="Forward to end">&gt;|</a>
                    </li>
                </ul>
            </nav>
        </div>
        <div class="col-md-3">
            <nav id="page-size-nav" aria-label="Page size selector" class="float-right">
                <ul class="pagination pagination-sm">
                    <li class="page-item disabled"><span class="page-link">Size:</span></li>
                    <li class="page-item page-size">
                        <a class="page-link" href="javascript:void(0);">9</a>
                    </li>
                    <li class="page-item page-size">
                        <a class="page-link" href="javascript:void(0);">18</a>
                    </li>
                    <li class="page-item page-size">
                        <a class="page-link" href="javascript:void(0);">36</a>
                    </li>
                    <li class="page-item page-size">
                        <a class="page-link" href="javascript:void(0);">72</a>
                    </li>
                    <li class="page-item page-size">
                        <a class="page-link" href="javascript:void(0);">all</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <div id="photos">
    </div>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/popper.min.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="bower_components/file-saver/FileSaver.min.js"></script>
<script src="js/jszip.min.js"></script>
<script src="js/jszip-utils.min.js"></script>
<script src="js/scripts.js"></script>
<script>
    let dir = "photos/";
    let fileExtension = ".jpg";
    let pageSize = 9;
    let pageNumber = 1;
    let numPages = 0;
    let pageWindow = 5;

    $('[data-toggle="tooltip"]').tooltip();

    let loadFunction = function () {
        $("#photos").html('');
        let url = dir + "?page=" + pageNumber + "&size=" + pageSize;

        function activateNextAndPrev() {
            if (1 === pageNumber) {
                console.log('Disabling prev and enabling next')
                $('.move-backwards').addClass('disabled');
                $('.move-forwards').removeClass('disabled');
            } else if (numPages === pageNumber) {
                console.log('Disabling next and enabling prev')
                $('.move-backwards').removeClass('disabled');
                $('.move-forwards').addClass('disabled');
            } else {
                console.log('Enabling next and prev')
                $('.move-backwards').removeClass('disabled');
                $('.move-forwards').removeClass('disabled');
            }
        }

        function buildPaginationLinks(response) {
            $('[data-toggle="tooltip"]').tooltip('hide');
            $('#page-nav li').each(function (idx, obj) {
                if (!$(obj).hasClass('move-backwards') && !$(obj).hasClass('move-forwards')) {
                    $(obj).remove();
                }
            });

            // Total number of pages needed to show all photos
            numPages = Math.ceil(response.total / pageSize);

            // The number of extra link slots to each side of the selected page
            let side = Math.floor(pageWindow / 2);

            // Where it would like to be
            let leftSidePointer = pageNumber - side;

            // If less than 1, we need to fix it to the first page
            let startNumber = (leftSidePointer < 1) ? 1 : leftSidePointer;

            // Carry over the missing pages from the left side and add them to the right
            let addToRightSide = (leftSidePointer < 1) ? leftSidePointer - 1 : 0;

            // If we are at the end always have a whole window of pages
            if (startNumber > numPages - pageWindow) {
                startNumber = numPages - pageWindow + 1;
            }

            // numPages if pageNumber plus the side goes over, otherwise the page number with the side and any extra from the left
            let endNumber = (((pageNumber + side) - numPages > 0) ? numPages : pageNumber + side) + (-addToRightSide);

            for (let i = startNumber; i <= endNumber; ++i) {
                let $link = $(
                    '<li class="page-item page-number"><a class="page-link" href="javascript:void(0);">' + i + '</a></li>'
                );
                if (i === pageNumber) {
                    $link.addClass('active');
                }
                $link.insertBefore(
                    $('#next')
                );
            }
        }

        function addClickHandlers() {
            $('.page-number').on('click', function (event) {
                let value = $(this).children('a').text();
                if (value > 0 && value <= numPages) {
                    pageNumber = parseInt(value);
                    console.log('page number changed to ' + value);
                    loadFunction();
                    event.stopPropagation();
                    return false;
                }
            });
        }

        function buildPhotoHtml(response) {
            let numOfPhotos = 0;
            let photoHTML = "";
            let data = response.files;
            data.sort();
            data.reverse();
            $.each(data, function () {
                console.log(this);
                //var filename = this.href.replace(window.location.host, "").replace("http://", "");
                var filename = this;
                if (filename.endsWith(fileExtension)) {
                    numOfPhotos++;
                    if (numOfPhotos % 3 === 0) {
                        console.log("Third photo.");
                        photoHTML += "<div class='col-md-4'><img src='" + dir + filename + "'></div></div>";
                    } else if (numOfPhotos % 3 === 1) {
                        console.log("First photo");
                        photoHTML += "<div class='row'><div class='col-md-4'><img src='" + dir + filename + "'></div>";
                    } else {
                        console.log("Middle photo");
                        photoHTML += "<div class='col-md-4'><img src='" + dir + filename + "'></div>";
                    }
                }
            });
            if (numOfPhotos % 3 !== 0) {
                console.log("did not finish on 3.");
                for (var i = 0; i < numOfPhotos % 3 - 1; i++) {
                    console.log("adding extra empty div");
                    photoHTML += "<div class='col-md-4'></div>";
                }
                photoHTML += "</div>";
            }
            if (numOfPhotos === 0) {
                $("#photos").append("<div class='row'><div class='col-md-12'><h2>No photos.</h2></div></div>");
                $("#download-zip").hide();
            } else {
                $("#photos").append(photoHTML);
            }
        }

        $('.page-size').each(function (idx, obj) {
            let value = $(obj).children('a').text();
            if (value == pageSize) {
                $(obj).addClass('active');
            } else {
                $(obj).removeClass('active');
            }
        });

        $.ajax({
            dataType: "json",
            url: url,
            error: function () {
                console.log("Error fetching directory.");
            },
            success: function (response) {
                console.log("Successfully fetched url: " + url);
                buildPaginationLinks(response);
                addClickHandlers();
                activateNextAndPrev();
                buildPhotoHtml(response);
            }
        });
    };

    loadFunction();

    $('.move-backwards').on('click', function (event) {
        let amount = $(this).data('amount');
        if ('all' === amount) {
            console.log('Setting to first page');
            pageNumber = 1;
        } else if (10 === amount && pageNumber > 2) {
            console.log('Go back 10 pages');
            pageNumber -= 10;
            if (pageNumber < 1) {
                pageNumber = 1;
            }
        } else if (1 === amount && pageNumber > 2) {
            console.log('Go back 1 page');
            --pageNumber;
        }
        console.log('page down', pageNumber);
        loadFunction();
    });

    $('.move-forwards').on('click', function (event) {
        let amount = $(this).data('amount');
        if ('all' === amount) {
            console.log('Setting to last page');
            pageNumber = numPages;
        } else if (10 === amount && pageNumber < numPages) {
            console.log('Go forward 10 pages');
            pageNumber += 10;
            if (pageNumber > numPages) {
                pageNumber = numPages;
            }
        } else if (1 === amount && pageNumber < numPages) {
            console.log('Go forward 1 page');
            ++pageNumber;
        }
        console.log('page up', pageNumber);
        loadFunction();
    });

    $('.page-size').on('click', function (event) {
        let value = $(this).children('a').text();
        console.log('page size changed to ' + value);
        pageSize = value;
        pageNumber = 1;
        loadFunction();
    });

    var Promise = window.Promise;
    if (!Promise) Promise = JSZip.external.Promise;

    function urlToPromise(url) {
        return new Promise(function (resolve, reject) {
            JSZipUtils.getBinaryContent(url, function (err, data) {
                if (err) {
                    reject(err);
                } else {
                    resolve(data);
                }
            });
        });
    }

    var isMobile = false; //initiate as false
    // device detection
    if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)
        || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0, 4))) isMobile = true;


    if (isMobile) $("#download-zip").hide();

    $("#download-zip").click(function () {
        $("#download-zip").text("Preparing photos...");
        $("#download-zip").prop("disabled", true);

        var zip = new JSZip();

        $("img").each(function (index) {
            var imgURL = $(this).attr("src");
            zip.file(imgURL.substring(imgURL.lastIndexOf('/') + 1), urlToPromise(imgURL), {binary: true});
        });

        zip.generateAsync({type: "blob"}, function updateCallback(metadata) {
            var msg = "progress : " + metadata.percent.toFixed(2) + "%";
            if (metadata.currentFile) {
                msg += ", current file = " + metadata.currentFile;
            }
            console.log(msg);
        }).then(function callback(blob) {
            saveAs(blob, "NaturewatchCameraPhotos.zip")
            $("#download-zip").text("Done!");
            setTimeout(function () {
                $("#download-zip").prop("disabled", false).text("Download all photos");
            }, 3000);
        })
    });
</script>
</body>
</html>
